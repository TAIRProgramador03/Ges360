<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Login Tair</title>
        <script src="https://kit.fontawesome.com/4f92527fbc.js" crossorigin="anonymous"></script>
        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
        <link rel="stylesheet" href="./public/css/style.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>
    <body>
        <div class="container">
            <div class="form-box login">
                <form class="sign-in" id="loginForm">
                    <img src="./public/img/trans-logo.png" width="200" height="100">
                    <div class="input-box">
                        <input type="text" name="dbUser" id="dbUser" placeholder="Usuario" required>
                        <i class='bx bxs-user'></i>
                    </div>
                    <div class="input-box">
                        <input type="password" name="password" id="password" placeholder="Contraseña" required>
                        <i class='bx bxs-lock-alt'></i>
                    </div>
                    <button type="submit" class="btn">Login</button>
                    <!--<p>or login with social platforms</p>
                    <div class="social-icons">
                        <a href="#"><i class='bx bxl-facebook' ></i></a>
                        <a href="#"><i class='bx bxl-google' ></i></a>
                        <a href="#"><i class='bx bxl-github' ></i></a>
                        <a href="#"><i class='bx bxl-linkedin' ></i></a>
                    </div>-->
                </form>
            </div>
            <div class="form-box register">
                <form class="sign-up" id="emailForm" method="POST" action="public/php/send_email.php">
                    <img src="./public/img/trans-logo.png" width="200" height="100">
                    <div class="input-box">
                        <input type="text" placeholder="Usuario" name="user" id="user" required>
                        <i class='bx bxs-user'></i>
                    </div>
                    <div class="input-box">
                        <input type="email" placeholder="Correo" name="email" id="email" required>
                        <i class='bx bxs-envelope' ></i>
                    </div>
                    <div class="input-box">
                        <input type="password" placeholder="Ultima contraseña que te recuerdes" name="pass" id="pass">
                        <i class='bx bxs-lock-alt'></i>
                    </div>
                    <button type="submit" class="btn">Register</button>
                    <!--<p>or register with social platforms</p>
                    <div class="social-icons">
                        <a href="#"><i class='bx bxl-facebook'></i></a>
                        <a href="#"><i class='bx bxl-google'></i></a>
                        <a href="#"><i class='bx bxl-github'></i></a>
                        <a href="#"><i class='bx bxl-linkedin'></i></a>
                    </div>-->
                </form>
            </div>
            <div class="toggle-box">
                <div class="toggle-panel toggle-left">
                    <h1>¡Hola, bienvenido!</h1>
                    <p>¿Olvidaste tu contraseña?</p>
                    <button class="btn register-btn">Recuperar</button>
                </div>
                <div class="toggle-panel toggle-right">
                    <h1>¡Bienvenido de nuevo!</h1>
                    <p>¿Recuerdas tu contraseña?</p>
                    <button class="btn login-btn">Loguearse</button>
                </div>
            </div>
        </div>
        <script>
            const emailField = document.querySelector("[name=email]");
            const setErrors = (message, field, isError = true) => {
                if (isError) {
                    field.classList.add("invalid");
                    field.nextElementSibling.classList.add("error");
                    field.nextElementSibling.innerText = message;
                } else {
                    field.classList.remove("invalid");
                    field.nextElementSibling.classList.remove("error");
                    field.nextElementSibling.innerText = "";
                }
            }
    
            const validateEmptyField = (message, e) => {
                const field = e.target;
                const fieldValue = e.target.value;
                if (fieldValue.trim().length === 0) {
                    setErrors(message, field);
                } else {
                    setErrors("", field, false);
                }
            }
            const validateEmailFormat = e => {
                const field = e.target;
                const fieldValue = e.target.value;
                const regex = new RegExp(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/);
                if (fieldValue.trim().length > 5 && !regex.test(fieldValue)) {
                    setErrors("Correo invalido", field);
                } else {
                    setErrors("", field, false);
                }
            }
            emailField.addEventListener("blur", (e) => validateEmptyField("Correo invalido", e));
            emailField.addEventListener("input", validateEmailFormat);
    
            document.getElementById('loginForm').addEventListener('submit', async function (e) {
                e.preventDefault(); // Prevenir el envío del formulario  #004f83
    
                const dbUser = document.getElementById('dbUser').value;
                const password = document.getElementById('password').value;
    
                try {
                    const response = await fetch('http://192.168.5.207:3000/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ dbUser, password })
                    });
                    const data = await response.json();
                    if (data.success) {
                        localStorage.setItem('dbUser', dbUser);
                        window.location.href = './public/vista/dashboard.php';
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Usuario o contraseña incorrecta',
                            confirmButtonColor: '#004f83'
                        });
                    }
                } catch (error) {
                    console.error('Error al hacer la solicitud:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexión',
                        text: 'No se pudo conectar con el servidor',
                        confirmButtonColor: '#004f83'
                    });
                }
            });
        </script>
        <script src="./public/js/login.js">Click</script>
    </body>
</html>